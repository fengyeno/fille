<?php// +----------------------------------------------------------------------// | OneThink [ WE CAN DO IT JUST THINK IT ]// +----------------------------------------------------------------------// | Copyright (c) 2013 http://www.onethink.cn All rights reserved.// +----------------------------------------------------------------------// | Author: 麦当苗儿 <zuojiazi@vip.qq.com> <http://www.zjzit.cn>// +----------------------------------------------------------------------namespace Admin\Controller;/** * 后台用户控制器 * @author 麦当苗儿 <zuojiazi@vip.qq.com> */class DateController extends AdminController {    /**     * 约会管理首页     * @author 麦当苗儿 <zuojiazi@vip.qq.com>     */    public function index(){        $status=I('status');        $uid=I('uid');        if($uid){            $map['uid']=$uid;        }else{            $map['uid']=array('neq',0);        }        if($status && in_array($status,array(1,2,3))){            $map['status']=1;        }else{            $map['status']  =   array('neq',-1);        }        $map['cid']=array('neq',0);        $count=M('user_date')->where($map)->count();        $page=new \Think\Page($count,10);        $list=M('user_date')->where($map)            ->order('create_time desc')->limit($page->firstRow,$page->listRows)            ->select();        foreach($list as $key=>$v){            $list[$key]['user']=$this->getUserNickname($v['uid']);            $list[$key]['typename']=$this->getTypeName($v['cid']);        }        $this->assign('_page',$page->show());        $this->assign('_list', $list);        $this->meta_title = '约会列表';        $this->display();    }    /*编辑约会*/    public function edit(){        $id=I('get.id');        if(IS_POST){            $arr=I('post.');            if(!$arr['place'] || !$arr['lng'] || !$arr['lat'] || !$arr['cid'] || !$arr['date_time']){                $this->error('参数不能为空');            }            if($id){                $arr['id']=$id;                $arr['update_time']=time();                $res=M('user_date')->save($arr);            }else{                $arr['status']=1;                $arr['create_time']=time();                $arr['update_time']=time();                $res=M('user_date')->add($arr);            }            if($res){                $this->success('操作成功',U('index'));            }else{                $this->error('操作失败');            }        }else{            if($id){                $info=M('user_date')->find($id);                $this->assign('info',$info);            }            $cate=$this->getTypeList();            $this->assign('cate',$cate);            $this->display();        }    }    /*获取类型列表*/    protected function getTypeList(){        $map['status']=1;        $field=array('id','title');        $list=M('user_date_cate')->field($field)->where($map)->order('level')->select();        return $list;    }    /*获取类型名*/    protected function getTypeName($cid){        $map['id']=$cid;        return M('user_date_cate')->where($map)->getField('title');    }    /*约会类型列表*/    public function cate(){        $map['status']=1;        $list=M('user_date_cate')->where($map)->order('level')->select();        $this->assign('_list',$list);        $this->display();    }    /*约会类型*/    public function editCate(){        $id=I('get.id');        if(IS_POST){            $arr=I('post.');            if(!$arr['title']){                $this->error('标题不能为空');            }            if(!$arr['pic']){                $this->error('请上传图片');            }            if($id){                $arr['id']=$id;                $arr['update_time']=time();                $res=M('user_date_cate')->save($arr);                S('date_cate_'.$id,null);            }else{                $arr['status']=1;                $arr['create_time']=time();                $arr['update_time']=time();                $res=M('user_date_cate')->add($arr);            }            if($res){                $this->success('操作成功',U('cate'));            }else{                $this->error('操作失败');            }        }else{            if($id){                $info=M('user_date_cate')->find($id);                $this->assign('info',$info);            }            $this->display('editcate');        }    }    /*删除*/    public function delCate(){        $id=I('ids');        if(is_array($id)){            $ids=implode(',',$id);            $map['id']=array('in',$ids);            $map['status']=1;            $res=M('user_date_cate')->where($map)->setField('status',-1);        }else{            $map['id']=$id;            $map['status']=1;            $res=M('user_date_cate')->where($map)->setField('status',-1);        }        if($res){            $this->success('删除成功',U('cate'));        }else{            $this->error('删除失败');        }    }    /*约会详情*/    public function detail(){        $id=I('get.id');        if(!$id){            $this->error('未知的约会');        }        $info=M('user_date')->find($id);        $info['user']=$this->getUserInfo($info['uid']);        $info['typename']=$this->getTypeName($info['cid']);        if($info['onuid']){            $info['onuser']=$this->getUserInfo($info['onuid']);        }        $this->assign('info',$info);        $this->display();    }    /*获取用户信息*/    protected function getUserInfo($uid){        $info=M('member')->find($uid);        if($info['vip']){            $vip=$this->getVip($info['vip']);            $info['vip']=$vip['title'];            $info['viplevel']=$vip['level'];        }        return $info;    }    /*获取vip等级*/    private function getVip($vid){        $map['id']=$vid;        $field=array('title','level');        return M('user_vip')->field($field)->where($map)->find();    }    /*约会说明*/    public function dateInfo(){        $path='Data/dateinfo.config';        if(IS_POST){            $arr=I('post.');            if(!$arr['head'] || !$arr['bottom'] || !$arr['buyabout']){                $this->error('信息不能为空');            }            $fp=fopen($path,'w+');            $str=json_encode($arr);            fwrite($fp,$str,strlen($str));            fclose($fp);            $this->success('操作成功');        }else{            if(is_file($path)){                $fp=fopen($path,'r');                $str=fread($fp,1024);                fclose($fp);                if($str){                    $info=json_decode($str,true);                    $this->assign('info',$info);                }            }            $this->display('dateinfo');        }    }}?>