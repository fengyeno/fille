<?php// +----------------------------------------------------------------------// | OneThink [ WE CAN DO IT JUST THINK IT ]// +----------------------------------------------------------------------// | Copyright (c) 2013 http://www.onethink.cn All rights reserved.// +----------------------------------------------------------------------// | Author: 麦当苗儿 <zuojiazi@vip.qq.com> <http://www.zjzit.cn>// +----------------------------------------------------------------------namespace Admin\Controller;/** * 后台审核控制器 * @author tang */class ExamController extends AdminController {    /**     * 图片审核列表     * @author tang     */    public function index(){        $map['status']=2;//        $map['type']=1;        $field=array('id','uid','thumb_360','pic','firsturl','type');        $count=M('user_album')->where($map)->count();        $page=new \Think\Page($count,9);        $list=M('user_album')->where($map)            ->order('create_time desc')->limit($page->firstRow,$page->listRows)            ->select();        foreach($list as $key=>$v){            $list[$key]['user']=$this->getUserInfo($v['uid']);            $list[$key]['thumb']=$v['firsturl'].$v['thumb_360'];        }        $this->assign('_page',$page->show());        $this->assign('_list', $list);        $this->meta_title = '图片审核列表';        $this->display();    }    /**     * 图片通过列表     * @author tang     */    public function picList(){        $map['status']=1;//        $map['type']=1;        $field=array('id','uid','thumb_360','pic','firsturl','type','create_time');        $count=M('user_album')->where($map)->count();        $page=new \Think\Page($count,10);        $list=M('user_album')->where($map)            ->order('create_time desc')->limit($page->firstRow,$page->listRows)            ->select();        foreach($list as $key=>$v){            $list[$key]['user']=$this->getUserInfo($v['uid']);            $list[$key]['thumb']=$v['firsturl'].$v['thumb_360'];            $list[$key]['pic']=$v['firsturl'].$v['pic'];        }        $this->assign('_page',$page->show());        $this->assign('_list', $list);        $this->meta_title = '已通过图片列表';        $this->display();    }    /**     * 删除会员相册     * @author tang     */    public function del_video(){        $id=I('get.id');        if(!$id){            $this->error("未知的视频");        }        $res=M('user_video')->where(array('id'=>$id))->delete();        if($res){            $this->success("删除成功",U('videolist'));        }else{            $this->error("删除失败");        }    }    /**     * 删除会员相册     * @author tang     */    public function del_album(){        $id=I('get.id');        if(!$id){            $this->error("未知的图片");        }        $res=M('user_album')->where(array('id'=>$id))->delete();        if($res){            $this->success("删除成功",U('piclist'));        }else{            $this->error("删除失败");        }    }    /*图片通过/不通过*/    public function setExamStatus(){        $status=I('get.status');        if(IS_POST){            $ids=I('post.ids');            if(empty($ids)){                $this->error('请选择图片');            }            $arr['id']=array('in',implode(',',$ids));            $arr['status']=$status;            $arr['update_time']=time();            $res=M('user_album')->save($arr);        }else{            $id=I('get.id');            if(!$id){                $this->error('未知的图片');            }            $arr['id']=$id;            $arr['status']=$status;            $arr['update_time']=time();            $res=M('user_album')->save($arr);        }        if($res){            $this->success('操作成功',U('index'));        }else{            $this->error('操作失败');        }    }    /*获取用户信息*/    protected function getUserInfo($uid){        $info=M('member')->find($uid);        if($info['vip']){            $vip=$this->getVip($info['vip']);            $info['vip']=$vip['title'];            $info['viplevel']=$vip['level'];        }        return $info;    }    /*获取vip等级*/    private function getVip($vid){        $map['id']=$vid;        $field=array('title','level');        return M('user_vip')->field($field)->where($map)->find();    }    /*视频认证列表*/    public function video(){        $prefix=C('DB_PREFIX');        $count=M()->table($prefix.'user_video v')            ->join($prefix.'member m on v.uid=m.uid')            ->where('v.status=2 and m.video=0')            ->count();        $page=new \Think\Page($count,10);        $list=M()->table($prefix.'user_video v')            ->join($prefix.'member m on v.uid=m.uid')            ->where('v.status=2 and m.video=0')            ->limit($page->firstRow,$page->listRows)            ->select();        $this->assign('_list',$list);        $this->assign('_page',$page->show());        $this->display();    }    /*视频认证结果*/    public function setUserVideoStatus(){        $status=I('get.status');        $id=I('get.id');        $uid=I('get.uid');        if(!$id){            $this->error('未知的视频');        }        $arr['id']=$id;        $arr['status']=$status;        $arr['update_time']=time();        $res=M('user_video')->save($arr);        M('member')->where(array('uid'=>$uid))->setField('video',1);        if($res){            $this->success('操作成功',U('video'));        }else{            $this->error('操作失败');        }    }    /*视频审核列表*/    public function videosh(){        $prefix=C('DB_PREFIX');        $count=M()->table($prefix.'user_video v')            ->join($prefix.'member m on v.uid=m.uid')            ->where('v.status=2 and m.video=1')            ->count();        $page=new \Think\Page($count,10);        $list=M()->table($prefix.'user_video v')            ->join($prefix.'member m on v.uid=m.uid')            ->where('v.status=2 and m.video=1')            ->limit($page->firstRow,$page->listRows)            ->select();        $this->assign('_list',$list);        $this->assign('_page',$page->show());        $this->display();    }    /*视频通过列表*/    public function videolist(){        $prefix=C('DB_PREFIX');        $count=M()->table($prefix.'user_video v')            ->join($prefix.'member m on v.uid=m.uid')            ->where('v.status=1 and m.video=1 and v.is_sign=0')            ->count();        $page=new \Think\Page($count,10);        $list=M()->table($prefix.'user_video v')            ->join($prefix.'member m on v.uid=m.uid')            ->where('v.status=1 and m.video=1 and v.is_sign=0')            ->order('v.create_time desc')            ->limit($page->firstRow,$page->listRows)            ->select();        $this->assign('_list',$list);        $this->assign('_page',$page->show());        $this->display();    }    /*视频通过列表*/    public function videolistsign(){        $prefix=C('DB_PREFIX');        $count=M()->table($prefix.'user_video v')            ->join($prefix.'member m on v.uid=m.uid')            ->where('v.status=1 and m.video=1 and v.is_sign=1')            ->count();        $page=new \Think\Page($count,10);        $list=M()->table($prefix.'user_video v')            ->join($prefix.'member m on v.uid=m.uid')            ->where('v.status=1 and m.video=1 and v.is_sign=1')            ->order('v.create_time desc')            ->limit($page->firstRow,$page->listRows)            ->select();        $this->assign('_list',$list);        $this->assign('_page',$page->show());        $this->display();    }    /*视频审核结果*/    public function setVideoStatus(){        $status=I('get.status');        $id=I('get.id');        if(!$id){            $this->error('未知的视频');        }        $arr['id']=$id;        $arr['status']=$status;        $arr['update_time']=time();        $res=M('user_video')->save($arr);        if($res){            $this->success('操作成功',U('videosh'));        }else{            $this->error('操作失败');        }    }    /*删除图片*/    public function del_pics(){        $ids=I('id');        if(is_array($ids)){            $ids=implode(",",$ids);        }        $map['id']=array('in',$ids);        $res=M('user_album')->where($map)->save(array('status'=>-1));//        echo M()->getLastSql();die;        if($res){            $this->success('删除成功',$_SERVER['HTTP_REFERER']?$_SERVER['HTTP_REFERER']:U('piclist'));        }else{            $this->error('删除失败'.M()->getDbError());        }    }}?>